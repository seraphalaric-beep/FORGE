// Prisma schema for FORGE
// All times stored in UTC, displayed in Europe/Dublin

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  discordId String   @unique
  joinedAt  DateTime @default(now())
  timezone  String   @default("Europe/Dublin")
  isActive  Boolean  @default(true)

  commitments    Commitment[]
  workouts       Workout[]
  pointsLedger   PointsLedger[]
  stravaIntegration IntegrationStrava?
  hevyIntegration   IntegrationHevy?

  @@index([discordId])
  @@index([isActive])
}

model Week {
  id                        String   @id @default(cuid())
  startsAt                  DateTime
  commitmentsOpenAt         DateTime
  commitmentsCloseAt        DateTime
  endsAt                    DateTime
  goalPoints                Int      @default(0)
  currentPoints             Int      @default(0)
  progressMessageChannelId   String?
  progressMessageId         String?
  commitmentMessageChannelId String?
  commitmentMessageId       String?
  status                    WeekStatus @default(OPEN)

  commitments   Commitment[]
  workouts      Workout[]
  pointsLedger  PointsLedger[]

  @@index([status])
  @@index([startsAt])
}

enum WeekStatus {
  OPEN    // Commitment window open
  ACTIVE  // Week in progress, commitments closed
  ENDED   // Week completed
}

model Commitment {
  id               String   @id @default(cuid())
  weekId           String
  userId           String
  committedWorkouts Int     // 0-7
  updatedAt        DateTime @default(now()) @updatedAt

  week Week @relation(fields: [weekId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekId])
  @@index([weekId])
  @@index([userId])
}

model Workout {
  id            String      @id @default(cuid())
  weekId        String
  userId        String
  source        WorkoutSource
  sourceEventId String?     // For idempotency: unique per source
  occurredAt    DateTime    // When the workout actually happened
  pointsAwarded Int         @default(10)
  createdAt     DateTime    @default(now())

  week Week @relation(fields: [weekId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([source, sourceEventId], name: "unique_source_event")
  @@index([weekId])
  @@index([userId])
  @@index([occurredAt])
}

enum WorkoutSource {
  MANUAL
  STRAVA
  HEVY
}

model PointsLedger {
  id       String   @id @default(cuid())
  weekId   String
  userId   String
  reason   String   // e.g., "workout_logged"
  points   Int
  createdAt DateTime @default(now())

  week Week @relation(fields: [weekId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([weekId])
  @@index([userId])
}

model WebhookEvent {
  id            String            @id @default(cuid())
  source        WebhookSource
  sourceEventId String
  receivedAt    DateTime          @default(now())
  processedAt   DateTime?
  status        WebhookEventStatus @default(PENDING)
  payloadJson   String            @db.Text

  @@unique([source, sourceEventId])
  @@index([status])
  @@index([source])
}

enum WebhookSource {
  STRAVA
  HEVY
}

enum WebhookEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model IntegrationStrava {
  id           String    @id @default(cuid())
  userId       String    @unique
  athleteId    String?   @unique
  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model IntegrationHevy {
  id        String   @id @default(cuid())
  userId    String   @unique
  hevyUserId String? @unique
  tokenOrKey String? @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

